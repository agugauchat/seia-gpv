@model Entities.PostEntities.Post

@{
    ViewBag.Title = Model.Title;
    var Comments = (List<Entities.CommentaryEntities.Commentary>)ViewBag.Comments;
    List<string> currentRoles = ViewBag.RolesOfCurrentUser as List<string>;
    var Comments = (List<Entities.CommentaryEntities.Commentary>)ViewBag.Comments;
    var userComplaints = (List<Entities.ComplaintEntities.Complaint>)ViewBag.UserComplaints;
}

@section Styles {
    <script type="text/javascript" src="~/Content/ckeditor/ckeditor.js"></script>
    <link href="~/Content/ckeditor/ckeditor_style.css" rel="stylesheet" />
    <!-- Custom CSS -->
    <link href="~/Content/blog-post.css" rel="stylesheet">
    <!-- Code Highlight -->
    <link href="~/Content/ckeditor/plugins/codesnippet/lib/highlight/styles/monokai_sublime.css" rel="stylesheet" />
}

<!-- Title -->
<h1>@Model.Title</h1>
<!-- Author -->
<p><span class="glyphicon glyphicon-time"></span> Publicado el @Model.EffectDate.ToString("dd/MM/yyyy") por <a href="#">@Model.WriterUserName</a></p>
<hr />
<!-- Preview Image -->
@*<img class="img-responsive" src="http://placehold.it/900x300" alt="">
    <hr>*@
<!-- Post Content -->
<p class="lead">@Html.Raw(Model.Body)</p>
@foreach (var tag in Model.Tags)
{
    <a href="@Url.Action(" List", "Post" , new { tag=tag })" class="tag-link"><span class="tag label label-info">@tag</span></a>
}
<hr>
<!-- Blog Comments -->
<!-- Comments Form -->
@if (Request.IsAuthenticated && currentRoles.Contains("User") && !currentRoles.Contains("Admin"))
{
<div class="well">
    <h4>Deja tu comentario:</h4>
    <form role="form">
        <div class="form-group">
            <textarea class="form-control" rows="3" maxlength="250" id="textComment"></textarea>
        </div>
        <button id="btnComment" class="btn btn-primary">Comentar</button>
    </form>
</div>
}
<hr>

@if (Comments.Any())
{
    foreach (var commentary in Comments)
    {
    <!-- Comment -->
        <div class="media">
            <a class="pull-left" href="#">
                <img class="media-object" src="~/Content/Images/GenericUser.png" height="64" width="64">
            </a>
            <div class="media-body">
                <h4 class="media-heading">
                    @commentary.WriterUserName
                    <small>@commentary.EffectDate</small>
                </h4>
                @commentary.CommentaryText
            </div>
        </div>
    }
    @*else
    {
    <h3>      No existen comentarios cargados para esta categoría.</h3>
    }*@
    <hr>
}

<div class="col-md-2">
<p>
    @Html.ActionLink("Volver", null, null, null, new { href = Request.UrlReferrer, @class = "btn btn-default" })
</p>
</div>

@*Verifica que el usuario esté logueado y que no haya denunciado anteriormente este post.*@
@if (User.Identity.IsAuthenticated && !userComplaints.Any(x => x.IdPost == Model.Id))
{
    <div class="col-md-offset-8 col-md-2">
        <a id="denunciate" href="#" class="btn btn-danger">Denunciar</a>
    </div>
    { Html.RenderPartial("_Complaint", new DotW.Models.ComplaintPostViewModel { PostId = Model.Id }); }
}


@section Scripts {
    <!-- View JavaScript -->
    <script src="~/Scripts/Post/Details.js"></script>
    <!-- Code Highlight -->
    <script src="~/Content/ckeditor/plugins/codesnippet/lib/highlight/highlight.pack.js"></script>
    <!-- Ajax for post -->
    <script>
        var idPost = parseInt('@Model.Id');
        $('#btnComment').click(function (e) {
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: "/Commentary/AddComment",
                content: "application/json; charset=utf-8",
                dataType: "json",
                data: {
                    text: $('#textComment').val(),
                    post: idPost
                },
                success: function (d) {
                    alert('Funcionó')
                }
            });
        });
    </script>
}